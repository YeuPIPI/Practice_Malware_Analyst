# Practice_Malware_Analyst
# Lab 1-1 This lab uses the files Lab01-01.exe and Lab01-01.dll. Use the tools and techniques described in the chapter to gain information about the files and answer the questions below

# 1. Upload the files to http://www.VirusTotal.com/ and view the reports. Does either file match any existing antivirus signatures?

có

MD5: 290934c61de9176ad682ffdd65f0a669

SHA256: f50e42c8dfaab649bde0398867e930b86c2a599e8db83b8260393082268f2dba

File name: Lab01-01.dll

MD5: bb7425b82141a1c0f7d60e5106676bb1


SHA256: 58898bd42c5bd3bf9b1389f0eee5b39cd59180e8370eb9ea838a0b327bd6fe47

File name: Mal01-01.exe

# 2. When were these files compiled?

Mal01-01.exe : 2010-12-19 16:16:19 UTC

Lab01-01.dll : 2010-12-19 16:16:38 UTC

# 3. Are there any indications that either of these files is packed or obfuscated? If so, what are these indicators?

những files này không bị pack hay obfuscated

# 4. Do any imports hint at what this malware does? If so, which imports are they?

![image](https://user-images.githubusercontent.com/72372550/220406995-478130fc-8b82-4d5c-b1ca-96c204afc3b0.png)

![image](https://user-images.githubusercontent.com/72372550/220407286-20dcfcea-3210-42cf-888d-988fc3d46e1d.png)



# 5. Are there any other files or host-based indicators that you could look for on infected systems?

Lab01-01.dll strings:

000000026018   000010026018      0   sleep

000000026020   000010026020      0   hello

000000026028   000010026028      0   127.26.152.13

000000026038   000010026038      0   SADFHUHF

Lab01-01.exe strings:

000000003010   000000403010      0   kerne132.dll

000000003020   000000403020      0   kernel32.dll

00000000304C   00000040304C      0   C:\windows\system32\kerne132.dll

000000003070   000000403070      0   Kernel32.

00000000307C   00000040307C      0   Lab01-01.dll

00000000308C   00000040308C      0   C:\Windows\System32\Kernel32.dll

000000003010   000000403010      0   kerne132.dll

000000003020   000000403020      0   kernel32.dll

0000000030B0   0000004030B0      0   WARNING_THIS_WILL_DESTROY_YOUR_MACHINE

# 6. What network-based indicators could be used to find this malware on infected machines?

127.26.152.13

# 7. What would you guess is the purpose of these files?

Nó sẽ tìm kiếm và sao chép các tệp sử dụng dll kết nối tới mạng backdoor tới miền ip 127.26.152.13 . Khi đó kẻ tấn công có thể sử dụng các command như hello , sleep và exec trên hệ thống bị nhiễm như lệnh ngủ và các lệnh hệ thống

# Lab 1-2

Analyze the file Lab01-02.exe
Questions

# 1. Upload the Lab01-02.exe file to http://www.VirusTotal.com/. Does it match any existing antivirus definitions?

có

MD5	8363436878404da0ae3e46991e355b83

SHA-1	5a016facbcb77e2009a01ea5c67b39af209c3fcb

SHA-256	c876a332d7dd8da331cb8eee7ab7bf32752834d4b2b54eaa362674a2a48f64a6


# 2. Are there any indications that this file is packed or obfuscated? If so, what are these indicators? If the file is packed, unpack it if possible.

DetectItEasy	PE32   Packer: UPX (3.04) [NRV,best]   Compiler: Microsoft Visual C/C++ (6.0)   Linker: Microsoft Linker (6.0) [Console32,console]

Sections
Name	Virtual Address	Virtual Size	Raw Size	Entropy	MD5	                              Chi2

UPX0	4096	           16384	      0	        0	      d41d8cd98f00b204e9800998ecf8427e	-1

UPX1	20480	           4096	        1536	    7.07	  ad0f236c2b34f1031486c8cc4803a908	5848.3

UPX2	24576	           4096	        512	      2.8	    f998d25f473e69cc89bf43af3102beea	53922

Chỉ số entropy khá cao cho thấy dấu hiệu rằng file đã bị pack ví dụ như UPX1 có chỉ số entropy là 7.07

Cách 1 : dùng tool https://upx.github.io/ 
để unpack file để có thể chạy ta dùng command sau : ./upx -d Lab01-02.exe -o Lab01-02_unpack.exe và ta sẽ được 1 file đã được unpack

Cách 2 : Tự unpack file bằng cách tìm OEP

Khi load vào IDA ta sẽ thấy ngay hàm pushad
![image](https://user-images.githubusercontent.com/72372550/220503828-400c0392-4600-4ad9-8e3c-56559eb87e99.png)
Đầu tiên nó sẽ lưu hết giá trị của các thanh ghi bằng lệnh pusha

Tiếp theo nó sẽ unpack hết các seations trong bộ nhớ

Nó sẽ fix lại IAT

Dùng lênh popad để khôi phục lại trạng thái của các thanh ghi

Và cuối cùng nhảy đến OEP để thực thi file như ban đầu
![image](https://user-images.githubusercontent.com/72372550/220504505-33afbe2d-111f-4d77-a5aa-c8a1c93b04c5.png)

Nhìn hình chúng ta có thể thấy lệnh popad và lệnh jmp near ptr dword_401190 vậy nên OEP chính là offset 0x401190

Chúng ta đã tìm được OEP h chúng ta sẽ fix lại IAT bằng tool Scylla . Đặt breakpoint tại điểm này để nhảy tới OEP

![image](https://user-images.githubusercontent.com/72372550/220506085-9733e7c2-53e8-4b2e-985d-2bce68902e53.png)

Đây là entrypoint của file gốc và khi đó chúng ta dùng Scylla để fix lại IAT

![image](https://user-images.githubusercontent.com/72372550/220506189-19377b1e-729c-451b-9bfc-09e8a2c7f662.png)

![image](https://user-images.githubusercontent.com/72372550/220506404-5ddfa7fd-ccc2-4bfe-9a5e-7a19f1ea6ce6.png)

Sau khi fix xong và dump bộ nhớ ra chúng ta cũng sẽ được 1 file đã unpack 

![image](https://user-images.githubusercontent.com/72372550/220506597-ff887cee-9399-45c7-bcb7-08f2dec4cd31.png)

# 3. Do any imports hint at this program’s functionality? If so, which imports are they and what do they tell you?

![image](https://user-images.githubusercontent.com/72372550/220519650-e707044b-5f33-46bd-9746-07efb5fb3f8e.png)
KERNEL32.DLL

SystemTimeToFileTime

GetModuleFileNameA

CreateMutexA

CreateThread

SetWaitableTimer

ADVAPI32.DLL

CreateServiceA

StartServiceCtrlDispatcherA

OpenSCManagerA

WININET.DLL

InternetOpenUrlA

InternetOpenA

# 4. What host- or network-based indicators could be used to identify this malware on infected machines?

Dịch vụ Malservice được cung cấp đến miền URL http://www.malwareanalysisbook.com

# Lab 1-3 Analyze the file Lab01-03.exe. Questions

# 1. Upload the Lab01-03.exe file to http://www.VirusTotal.com/. Does it match any existing antivirus definitions?

MD5	9c5c27494c28ed0b14853b346b113145

SHA-1	290ab6f431f46547db2628c494ce615d6061ceb8

SHA-256	7983a582939924c70e3da2da80fd3352ebc90de7b8c4c427d484ff4f050f0aec


# 2. Are there any indications that this file is packed or obfuscated? If so, what are these indicators? If the file is packed, unpack it if possible.

Ta thấy nó đã bị pack FSG

DetectItEasy	PE32   Packer: FSG (1.0)

File size	4.64 KB (4752 bytes)

PEiD packer	FSG v1.00 (Eng) -> dulek/xt


Ta sẽ dùng tool OllyDBG để tìm OEP
![image](https://user-images.githubusercontent.com/72372550/221394751-fed07134-4183-416e-aa03-0c09e63e4fde.png)

Ta sẽ dùng chức năng trace từng bytewase( very slow) 

![image](https://user-images.githubusercontent.com/72372550/221394780-cb7d7253-282b-4614-8938-24efb704a64f.png)

Sau đó load lại file và bật chức năng stop at entry of self-extrator 

![image](https://user-images.githubusercontent.com/72372550/221394826-db47968f-0776-4737-9d06-8eea2fdf1b93.png)

Khi đó nó sẽ nhảy đến địa chỉ 0x00401090 như hình dưới vậy OEP chính là offset 0x004001090

![image](https://user-images.githubusercontent.com/72372550/221394883-9127596f-05d6-4b2d-bf27-6bab90093f78.png)

Sau khi tìm được OEP ta sẽ tiến hành dump file và fix lại IAT . Ta sẽ đặt breakpoint tại điểm nhảy tới OEP 

![image](https://user-images.githubusercontent.com/72372550/221394950-36153975-8cbe-493b-a3e7-64c17e59818a.png)

![image](https://user-images.githubusercontent.com/72372550/221395031-79854007-75ed-4cde-b9d8-33b380ded191.png)

![image](https://user-images.githubusercontent.com/72372550/221395130-20fa80f6-3852-49f9-8e20-36ee7be98546.png)

Ta sẽ được 1 file đã unpack . Ta thấy sau khi unpack delect it easy đã nhận được được trình biên dịch 

![image](https://user-images.githubusercontent.com/72372550/221395182-433ca1db-d78d-45fe-b4e0-5c99d8ee720d.png)

# 3. Do any imports hint at this program’s functionality? If so, which imports are they and what do they tell you?

![image](https://user-images.githubusercontent.com/72372550/221395456-a4179ae0-ad2a-4151-9f3c-e7cfb3b71e5e.png)

![image](https://user-images.githubusercontent.com/72372550/221395500-4af0de23-ad1b-49af-9aa0-b7b816197d80.png)

Chúng ta có thể thấy nó có dll OLEAUT32.DLL dùng băm header

# 4. What host- or network-based indicators could be used to identify this malware on infected machines?

http://www.malwareanalysisbook.com/ad.html

ở trong string hiển thị 1 miền URL có khả năng nó kết nối tới miền dịch vụ này

# Lab 1-4 Analyze the file Lab01-04.exe. Questions

# 1. Upload the Lab01-04.exe file to http://www.VirusTotal.com/. Does it match any existing antivirus definitions?

59 security vendors and 1 sandbox flagged this file as malicious

MD5	625ac05fd47adc3c63700c3b30de79ab

SHA-1	9369d80106dd245938996e245340a3c6f17587fe

SHA-256	0fa1498340fca6c562cfa389ad3e93395f44c72fd128d7ba08579a69aaf3b126

# 2. Are there any indications that this file is packed or obfuscated? If so, what are these indicators? If the file is packed, unpack it if possible.
DetectItEasy	PE32   Compiler: EP:Microsoft Visual C/C++ (6.0 (1720-9782)) [EXE32]   Compiler: Microsoft Visual C/C++ (6.0) [msvcrt]   Linker: Microsoft Linker (6.0*)[GUI32]

File size	36.00 KB (36864 bytes)

PEiD packer	Microsoft Visual C++

Cyren packer	rsrc
![image](https://user-images.githubusercontent.com/72372550/220807331-92b295fa-39f5-4034-8191-42e4b0a8964e.png)

# 3. When was this program compiled?

![image](https://user-images.githubusercontent.com/72372550/220807366-e4b3b773-92e7-4e3f-b18e-3907aad56097.png)

# 4. Do any imports hint at this program’s functionality? If so, which imports are they and what do they tell you?
![image](https://user-images.githubusercontent.com/72372550/220807609-41f2cc04-cce3-423c-abb1-adc76b77ce1c.png)

# 5. What host- or network-based indicators could be used to identify this malware on infected machines?
![image](https://user-images.githubusercontent.com/72372550/220807914-b3ba7b8d-3a3c-441f-9607-151ad3f3478b.png)

# 6. This file has one resource in the resource section. Use Resource Hacker to examine that resource, and then use it to extract the resource. What can you learn from the resource?
nó dùng 1 thư viện dll để dowload file
![image](https://user-images.githubusercontent.com/72372550/220809326-179826ef-5bdf-4e6f-8df2-21cd34ecad2c.png)

# Lab 3-1 Analyze the malware found in the file Lab03-01.exe using basic dynamic analysis tools.
# Questions

# 1. What are this malware’s imports and strings? 

Nó import api ExitProcess từ kernel32

![image](https://user-images.githubusercontent.com/72372550/221392012-a16f48ce-e83a-4023-be81-698da3cb5576.png)

![image](https://user-images.githubusercontent.com/72372550/221392015-c0186014-69d4-44a8-af30-667a5c7be538.png)

Có vẻ như nó sẽ kết nối đến 1 URL và thay đổi giá trị của 1 số khóa , ngoài ta còn có vmx32to64.exe là tên phần mềm độc hại

# 2. What are the malware’s host-based indicators?

WinVMX32, vmx32-to64.exe trong C:\WINDOWS\system32 , VideoDriver 

# 3. Are there any useful network-based signatures for this malware? If so, what are they

Chúng ta có thể tháy nó kết nối đến 1 miền www.practicalmalwareanalysis.com

# Lab 3-2 Analyze the malware found in the file Lab03-02.dll using basic dynamic analysis tools.

# 1. How can you get this malware to install itself?

Vì đây là 1 file dll mã độc nên chúng ta có thể sử dụng rundll32.exe để chạy . Để chạy rundll32.exe chúng ta cần biết cần biết tên dll và tên func export

![image](https://user-images.githubusercontent.com/72372550/222377901-92bac1b7-7103-46db-abc2-ca7cc6f89d74.png)

Nhìn ảnh chúng ta có thể thấy 1 hàm tên là installA

sau khi chạy rundll32.exe Lab03-02.dll installA . Chúng ta sẽ theo dõi trên regshot và so sánh thì chúng ta sẽ có giá trị sau 

----------------------------------
Keys added: 9

----------------------------------

HKLM\SYSTEM\ControlSet001\Services\IPRIP

HKLM\SYSTEM\ControlSet001\Services\IPRIP\Parameters

HKLM\SYSTEM\ControlSet001\Services\IPRIP\Security

HKLM\SYSTEM\CurrentControlSet\Services\IPRIP

HKLM\SYSTEM\CurrentControlSet\Services\IPRIP\Parameters

HKLM\SYSTEM\CurrentControlSet\Services\IPRIP\Security

HKU\S-1-5-21-2025429265-1708537768-1060284298-1003\Software\Microsoft\Windows\CurrentVersion\Explorer\ComDlg32\OpenSaveMRU\hivu

HKU\S-1-5-21-2025429265-1708537768-1060284298-1003\Software\Microsoft\Windows\CurrentVersion\Explorer\FileExts\.hivu

HKU\S-1-5-21-2025429265-1708537768-1060284298-1003\Software\Microsoft\Windows\CurrentVersion\Explorer\FileExts\.hivu\OpenWithList

----------------------------------

Values added: 37

----------------------------------

HKLM\SYSTEM\ControlSet001\Services\IPRIP\Type: 0x00000020

HKLM\SYSTEM\ControlSet001\Services\IPRIP\Start: 0x00000002

HKLM\SYSTEM\ControlSet001\Services\IPRIP\ErrorControl: 0x00000001

HKLM\SYSTEM\ControlSet001\Services\IPRIP\ImagePath: "%SystemRoot%\System32\svchost.exe -k netsvcs"

HKLM\SYSTEM\ControlSet001\Services\IPRIP\DisplayName: "Intranet Network Awareness (INA+)"

HKLM\SYSTEM\ControlSet001\Services\IPRIP\ObjectName: "LocalSystem"

HKLM\SYSTEM\ControlSet001\Services\IPRIP\Description: "Depends INA+, Collects and stores network configuration and location information, and notifies applications when 

this information changes."

HKLM\SYSTEM\ControlSet001\Services\IPRIP\DependOnService:  52 00 70 00 63 00 53 00 73 00 00 00 00 00

HKLM\SYSTEM\ControlSet001\Services\IPRIP\Parameters\ServiceDll: "C:\Documents and Settings\Brett Lischalk\Desktop\Practical Malware Analysis 

Labs\BinaryCollection\Chapter_3L\Lab03-02.dll"

HKLM\SYSTEM\ControlSet001\Services\IPRIP\Security\Security:  01 00 14 80 90 00 00 00 9C 00 00 00 14 00 00 00 30 00 00 00 02 00 1C 00 01 00 00 00 02 80 14 00 FF 01 0F 

00 01 01 00 00 00 00 00 01 00 00 00 00 02 00 60 00 04 00 00 00 00 00 14 00 FD 01 02 00 01 01 00 00 00 00 00 05 12 00 00 00 00 00 18 00 FF 01 0F 00 01 02 00 00 00 00 00 

05 20 00 00 00 20 02 00 00 00 00 14 00 8D 01 02 00 01 01 00 00 00 00 00 05 0B 00 00 00 00 00 18 00 FD 01 02 00 01 02 00 00 00 00 00 05 20 00 00 00 23 02 00 00 01 01 00 

00 00 00 00 05 12 00 00 00 01 01 00 00 00 00 00 05 12 00 00 00

HKLM\SYSTEM\CurrentControlSet\Services\IPRIP\Type: 0x00000020

HKLM\SYSTEM\CurrentControlSet\Services\IPRIP\Start: 0x00000002

HKLM\SYSTEM\CurrentControlSet\Services\IPRIP\ErrorControl: 0x00000001

HKLM\SYSTEM\CurrentControlSet\Services\IPRIP\ImagePath: "%SystemRoot%\System32\svchost.exe -k netsvcs"

HKLM\SYSTEM\CurrentControlSet\Services\IPRIP\DisplayName: "Intranet Network Awareness (INA+)"

HKLM\SYSTEM\CurrentControlSet\Services\IPRIP\ObjectName: "LocalSystem"

# 2. How would you get this malware to run after installation?

net start IPRIP 

Nhìn vào kết nối mạng chúng ta có thể thấy nó kết nối đến miền practicalmalwareanalysis.com

# 3. How can you find the process under which this malware is running?

Chúng ta có thể dùng process explorer để quan sát và xem nhìn thấy 1 process lab3-2.dll dưới process svchost.exe 

# 4. Which filters could you set in order to use procmon to glean information?

Chúng ta có thể sử dụng process id

# 5. What are the malware’s host-based indicators?

nó viết reg HKLM\SYSTEM\ControlSet001\Services\IPRIP\Parameters\ServiceDll: %CurrentDirectory%\Lab03-02.dll trong registry để thực hiện persistant

# 6. Are there any useful network-based signatures for this malware?

nó sẽ sử dụng method GET để kết nối tới practicalmalwareanalysis.com/serve.html

# Lab 3-3 Execute the malware found in the file Lab03-03.exe while monitoring it using basic dynamic analysis tools in a safe environment.

# 1. What do you notice when monitoring this malware with Process Explorer?

Khi chạy phần mềm và quan sát dưới process explorer chúng ta sẽ thấy có thêm 1 tiến trình svchost trước khi nó biến mất . Đó có thể là kỹ thuật process hollowing là 1 

kỹ thuật dùng tiến trình làm vỏ bọc của 1 tiến trình nguy hiểm 

# 2. Can you identify any live memory modifications?

![image](https://user-images.githubusercontent.com/72372550/221621194-2c9c0938-4122-471d-b49a-f323bd672eb2.png)

SetWindowsHookExA, practicalmalwareanalysis.log, và [CAPS LOCK] chúng ta có thể nhìn thấy các string trong tiến hình nên có khả năng đây là 1 keylogger

# 3. What are the malware’s host-based indicators?

Chúng ta có thể thấy nó sinh ra 1 file practicalmalwareanalysis.log và khi mở file thì thấy ghi lại các phím đã được nhập

Phân tích nhanh qua phân tích động thì về cơ bản nó chỉ lưu lại ký tự chứ không mở kết nối tới miền nào . Lướt qua thử phân tích tĩnh thì chúng ta thu thập các thông 

tin sau . Trong hàm main nó có 3 hàm chính 

![image](https://user-images.githubusercontent.com/72372550/221623642-7e403b48-1ab4-40ce-908b-6d534187d931.png)

Hàm đầu tiên sẽ là lấy thông tin về hệ thống 

![image](https://user-images.githubusercontent.com/72372550/221624065-0d3dbc29-ef44-4450-a25b-dc54da536d5b.png)

Hàm thứ 2 thì chúng ta có thể thấy nó dùng các api cung cấp tài nguyên 

![image](https://user-images.githubusercontent.com/72372550/221625583-d8c5223b-663d-4e7b-9712-5ff2239db72a.png)

Và hàm cuối cùng là chính sẽ có nhiệm vụ chính là ghi lại ký tự các lưu vào file 

![image](https://user-images.githubusercontent.com/72372550/221626713-c18c7fd3-349c-4eb4-8717-8f002e9e9f81.png)


# 4. What is the purpose of this program?

Đây là 1 mã độc keylogger và nó sẽ lưu hết các ký tự đã nhập vào 1 file . Phân tích động k thấy có kết nối mạng

# Lab 3-4 Analyze the malware found in the file Lab03-04.exe using basic dynamic analysis tools. (This program is analyzed further in the Chapter 9 labs.)

# 1. What happens when you run this file?

Khi chúng ta chạy file sau vài giây nó sẽ tự động xóa process chính nó

# 2. What is causing the roadblock in dynamic analysis? 

Vì ở đây giới hạn là phân tích động không phân tích tĩnh nên chúng ta k biết gì nhiều . Có thể là do có chức năng phát hiện trong sandbox , máy ảo hoặc cũng có thể nó 

chỉ chạy trong 1 số múi giò nhất định

# 3. Are there other ways to run this program?

Dùng 1 số parameter hoặc là debug nó

# Lab 5-1 

Analyze the malware found in the file Lab05-01.dll using only IDA Pro. The goal of this lab is to give you hands-on experience with IDA Pro. If you’ve already 

workedwith IDA Pro, you may choose to ignore these questions and focus on reverse-engineering the malware.

# 1. What is the address of DllMain?

Nó ở địa chỉ 0x1000D02E . Chúng ta có thể dễ dàng load vào IDA và thấy điều đó 

# 2. Use the Imports window to browse to gethostbyname. Where is the import located?

![image](https://user-images.githubusercontent.com/72372550/226518572-207a05f5-4214-417f-b704-749189c6b371.png)

# 3. How many functions call gethostbyname?

![image](https://user-images.githubusercontent.com/72372550/226518607-8db4978a-5154-44d6-a278-98134c53ebbf.png)

# 4. Focusing on the call to gethostbyname located at 0x10001757, can you figure out which DNS request will be made?

![image](https://user-images.githubusercontent.com/72372550/227081014-f899a20d-887b-488a-84b1-c7e61192220a.png)

Focus theo hàm gethostbyname ở địa chỉ kia chúng ta có thể thấy nó kết nối đến miền DNS như trong ảnh

# 5. How many local variables has IDA Pro recognized for the subroutine at 0x10001656?

![image](https://user-images.githubusercontent.com/72372550/227081590-692a1ed4-447b-4049-b27c-776cb9d7d2d3.png)

Dựa vào hình trên chúng ta có thể thấy nó là 23 dựa vào thanh ghi EBP

# 6. How many parameters has IDA Pro recognized for the subroutine at 0x10001656?

Tương tự câu 5 chúng ta có thể thấy nó là 1 

# 7. Use the Strings window to locate the string \cmd.exe /c in the disassembly. Where is it located?

![image](https://user-images.githubusercontent.com/72372550/227082060-4839555e-abd2-4f5f-be6b-e2a93312c406.png)

# 8. What is happening in the area of code that references \cmd.exe /c?

![image](https://user-images.githubusercontent.com/72372550/227082816-a76188a0-dac0-4c91-8201-3c4290337db8.png)

![image](https://user-images.githubusercontent.com/72372550/227083204-d4997a8b-8529-44c0-be61-ecaaf33cd360.png)

Từ những hình trên chúng ta có thể suy luận hàm này là remoteshell

# 9. In the same area, at 0x100101C8, it looks like dword_1008E5C4 is a global variable that helps decide which path to take. How does the malware set dword_1008E5C4? (Hint: Use dword_1008E5C4’s cross-references.)

![image](https://user-images.githubusercontent.com/72372550/227084336-af3c482e-820a-43e5-b276-6c3f3cb696ef.png)

Nhìn hình chúng ta có thể thấy nó read biến dword_1008E5C4 tại 2 hàm và chỉ có 1 hàm là write nó . 

![image](https://user-images.githubusercontent.com/72372550/227084568-5093c176-be97-495b-b5e4-6eb4b649ecd9.png)

Đi vào hàm trên chúng ta có thể thấy nó là giá trị trả về của hàm sub_1003695 . đi tiếp vào hàm đó thì chúng ta thấy hàm này là 1 hàm check version OS . Vậy chúng ta 

có thể hiểu đơn rằng ý nghĩa nó là như sau :

if version == VER_PLATFORM_WIN32_NT:
  
  CmdExe = cmd.exe

else:
  
  CmdExe = command.exe

![image](https://user-images.githubusercontent.com/72372550/227085292-e8691eb9-6599-4547-a1dc-12a215d4ec3f.png)


# 10. A few hundred lines into the subroutine at 0x1000FF58, a series of comparisons use memcmp to compare strings. What happens if the string comparison to robotwork is successful (when memcmp returns 0)?

![image](https://user-images.githubusercontent.com/72372550/227086309-f9a15024-93cb-44bd-82d7-ff0f1f965118.png)

Nếu so sánh thành công thì nó sẽ đi vào hàm sub_10052A2

![image](https://user-images.githubusercontent.com/72372550/227086884-d759cd04-27b8-4f65-ba39-f63927b35f40.png)

![image](https://user-images.githubusercontent.com/72372550/227088165-cb3208d0-0a11-416d-9507-0dcee5af8a82.png)


Nhìn vào hình chúng ta có thể suy luận là nó sẽ đăng ký 1 key và add value là WorkTime

# 11. What does the export PSLIST do?

![image](https://user-images.githubusercontent.com/72372550/227093019-d5a2440f-6bac-48ce-aa77-fd7c20f91a64.png)


Đi vào hàm PSLIST chúng ta có thể thấy có 1 biến result được trả về từ hàm sub_100036C3 . Đi vào hàm sub_100036C3 chúng ta có thể thấy 1 hàm CheckOS tương tự như câu 9 

Đầu tiên nó so sánh version với 2 nếu đúng thì OS đang chạy là Windows NT . Tiếp theo nó so sánh giá trị ở ebp + var_84 chính là dwMajorVersion của nó . Nếu nó bằng 5

tức là máy nạn nhân đang chạy version Windows 2000, Windows XP, Windows Server 2003, or Windows Server 2003 R2 . Nếu nó không bằng 5 mà lớn hơn thì eax = 0 còn ngược 

lại thì eax = 1 

Nhìn tiếp vào hàm PSLIST chúng ta thấy nó lấy result để so sánh . CHúng ta sẽ bật graph để có thể dễ dàng quan sát hơn 

![image](https://user-images.githubusercontent.com/72372550/227093439-5d1e3777-9d39-4b6c-8c35-0c17763adbcd.png)

Chúng ta có thể thấy tùy vào OS nó sẽ gọi tới 2 hàm khác nhau là sub_1000664C và hàm sub_1000651B . Sau khi xem qua 2 hàm thì chúng ta có thể thấy nó sẽ dùng 

CreateToolhelp32Snapshot() để lấy pid và tên process của tiến trình trong máy sau đó nó sẽ send thông tin đó qua 1 socket . Nó ghi lại các thông tin nó lấy được vào 

xinstall.dll

![image](https://user-images.githubusercontent.com/72372550/227094207-28d040c2-c32b-4b7c-9f5e-507023a2b2e6.png)

![image](https://user-images.githubusercontent.com/72372550/227094297-2a84c150-8db1-43b9-986c-3df1b3257c98.png)

Nhìn hình chúng ta có thể thấy nó openprocess và EnumProcessModules đều là bật và xem process đang load các dll , tiến trình con nào . Sau khi duyệt qua hết xong thì 

nó sẽ closehandle

# 12. Use the graph mode to graph the cross-references from sub_10004E79. Which API functions could be called by entering this function? Based on the API functions alone, what could you rename this function?

Khi mở hàm sub_10004E79

![image](https://user-images.githubusercontent.com/72372550/227094888-a1d0b45f-4ac7-48fd-87ce-e5c4273b563d.png)

nhìn vào hình chúng ta thấy nó gọi hàm GetSystemDefaultLangID() . Chúng ta có thể suy đoán hàm này là lấy mã ngôn ngữ của hệ thống mặc định . Hàm trả về một giá trị 

kiểu LANGID, được sử dụng để đại diện cho mã ngôn ngữ, ví dụ: tiếng Anh là 0x0409, tiếng Nhật là 0x0411. Hàm này có thể được sử dụng để xác định ngôn ngữ hiển thị trên 

hệ thống, hoặc để thực hiện các hoạt động phụ thuộc vào ngôn ngữ của hệ thống. Vậy chúng ta có thể đổi tên hàm là Get_Language_ID 

# 13. How many Windows API functions does DllMain call directly? How many at a depth of 2?

![image](https://user-images.githubusercontent.com/72372550/227097469-4b6d56b4-fb4c-4394-bf43-9f4357aecb8f.png)

Và khi depth là 2 

![image](https://user-images.githubusercontent.com/72372550/227097582-b8a887ed-3003-4a14-b68c-52fe9fabe660.png)


# 14. At 0x10001358, there is a call to Sleep (an API function that takes one parameter containing the number of milliseconds to sleep). Looking backward through the code, how long will the program sleep if this code executes?

![image](https://user-images.githubusercontent.com/72372550/227097734-8687e83e-bff4-4921-ab35-b26af027896d.png)

Nhìn vào hình chúng ta có thể thấy trước hàm sleep nó gọi hàm atoi có giá trị là atoi(off_10019020[0] + 13) và khi đi vào hàm đó ở vị trí 13 chúng ta có thể thấy giá 

giá trị là 30 . Vậy hàm sleep sẽ là 30 * 1000 = 30000ms là 30s

# 15. At 0x10001701 is a call to socket. What are the three parameters?

![image](https://user-images.githubusercontent.com/72372550/227098248-05b5bc5e-f896-41c9-893e-7395ff063ded.png)

Chúng ta có thể thấy nó lần lượt push 6 , 1 , 2 vào

# 16. Using the MSDN page for socket and the named symbolic constants functionality in IDA Pro, can you make the parameters more meaningful?What are the parameters after you apply changes?

AF_INET = 2 (IPv4)

SOCK_STREAM = 1 (TCP)

IPPROTO_TCP = 6 (TCP)

# 17. Search for usage of the in instruction (opcode 0xED). This instruction is used with a magic string VMXh to perform VMware detection. Is that in use in this malware? Using the cross-references to the function that executes the in instruction, is there further evidence of VMware detection?

![image](https://user-images.githubusercontent.com/72372550/227099387-4ac82fdc-583e-497c-9daf-726d0aa738d4.png)

![image](https://user-images.githubusercontent.com/72372550/227099696-8f2d8fc1-9d2a-4f91-985b-09785e336f4d.png)

Có vẻ như chương trình này có khả năng phát hiện VMware . Khi bật danh sách các hàm gọi đến hàm này và mở thử 1 hàm thì chúng ta thấy điều này 

![image](https://user-images.githubusercontent.com/72372550/227099982-d712d756-eccb-4506-bfff-66d732bd5a69.png)

Nó sẽ phát hiện chúng ta debug nó trong máy ảo . Đây có lẽ là 1 kỹ thuật anti debug trong máy ảo 

# 18. Jump your cursor to 0x1001D988. What do you find? 

![image](https://user-images.githubusercontent.com/72372550/227100476-0bbfe21b-ac1e-45f0-bed1-c0627e79d04f.png)

# 19. If you have the IDA Python plug-in installed (included with the commercial version of IDA Pro), run Lab05-01.py, an IDA Pro Python script provided with the malware for this book. (Make sure the cursor is at 0x1001D988.) What happens after you run the script?

Mở thử file script thì chúng ta thấy nó là phép xor cơ bản

![image](https://user-images.githubusercontent.com/72372550/227103529-beeed415-5973-423a-9e1e-8634247917d4.png)

![image](https://user-images.githubusercontent.com/72372550/227103546-644abb19-7253-4acd-bdcd-0a6d70c59645.png)

Nó sẽ xor cái byte ở vị trí 0x1001D988 có size là 0x50 với giá trị là 0x55

# 20. With the cursor in the same location, how do you turn this data into a single ASCII string?

Nhấn A

# 21. Open the script with a text editor. How does it work?

Như nói câu 19 là nó sẽ xor từng byte ở bắt đầu vị trí 0x1001D988 với 0x50 lần và key là 0x55
